<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        
        input, select { margin-bottom: 15px; padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #a71d2a; }

       
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }

       
        .section { display: none; } /* Hidden by default */
        .active-section { display: block; }
        
        .nav-bar { margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .nav-bar button { background: none; color: #555; margin-right: 10px; }
        .nav-bar button.active { color: #007bff; border-bottom: 3px solid #007bff; }

        
        #auth-container { max-width: 400px; margin: 100px auto; text-align: center; }
    </style>
</head>
<body>

    <div id="auth-container" class="container">
        <h1>Welcome</h1>
        <div id="login-form">
            <h3>Login</h3>
            <input type="text" id="login-username" placeholder="Username">
            <input type="password" id="login-password" placeholder="Password">
            <button onclick="login()">Login</button>
            <p>Don't have an account? <a href="#" onclick="toggleAuth('register')">Register</a></p>
        </div>

        <div id="register-form" style="display:none;">
            <h3>Register</h3>
            <input type="text" id="reg-username" placeholder="Username">
            <input type="password" id="reg-password" placeholder="Password">
            <select id="reg-role">
                <option value="Student">Student</option>
                <option value="Teacher">Teacher</option>
                <option value="Admin">Admin</option>
            </select>
            <button onclick="register()">Register</button>
            <p>Already have an account? <a href="#" onclick="toggleAuth('login')">Login</a></p>
        </div>
    </div>

    <div id="main-app" class="container" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>School Manager</h1>
            <button class="btn-danger" onclick="logout()">Logout</button>
        </div>

        <div class="nav-bar">
            <button onclick="showSection('students')" id="nav-students">Students</button>
            <button onclick="showSection('teachers')" id="nav-teachers">Teachers</button>
            <button onclick="showSection('attendance')" id="nav-attendance">Attendance</button>
        </div>

        <div id="section-students" class="section">
            <h3>Add Student</h3>
            <input type="text" id="stu-fname" placeholder="First Name">
            <input type="text" id="stu-lname" placeholder="Last Name">
            <input type="email" id="stu-email" placeholder="Email">
            <button onclick="addStudent()">Add Student</button>
            
            <h3>All Students</h3>
            <table id="table-students">
                <thead><tr><th>ID</th><th>First Name</th><th>Last Name</th><th>Email</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="section-teachers" class="section">
            <h3>Add Teacher</h3>
            <input type="text" id="teach-fname" placeholder="First Name">
            <input type="text" id="teach-lname" placeholder="Last Name">
            <input type="text" id="teach-subject" placeholder="Subject">
            <button onclick="addTeacher()">Add Teacher</button>
            
            <h3>All Teachers</h3>
            <table id="table-teachers">
                <thead><tr><th>ID</th><th>First Name</th><th>Last Name</th><th>Subject</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="section-attendance" class="section">
            <h3>Mark Attendance</h3>
            <input type="number" id="att-stu-id" placeholder="Student ID (e.g., 1)">
            <input type="date" id="att-date">
            <select id="att-status">
                <option value="Present">Present</option>
                <option value="Absent">Absent</option>
            </select>
            <button onclick="markAttendance()">Submit Attendance</button>
            
            <h3>View Attendance</h3>
            <button onclick="fetchAttendance()">Refresh List</button>
            <table id="table-attendance">
                <thead><tr><th>ID</th><th>Date</th><th>Student ID</th><th>Status</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5000';
        let token = localStorage.getItem('access_token');

       
        if (token) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            showSection('students');
        }

        function toggleAuth(view) {
            if(view === 'register') {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            } else {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('register-form').style.display = 'none';
            }
        }

        async function register() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const role = document.getElementById('reg-role').value;

            const res = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, role })
            });

            if (res.ok) {
                alert("Registered! Please login.");
                toggleAuth('login');
            } else {
                alert("Registration failed");
            }
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            const data = await res.json();

            if (res.ok) {
                token = data.access_token;
                localStorage.setItem('access_token', token); // Save token
                location.reload(); // Refresh page to show dashboard
            } else {
                alert("Login failed: " + data.message);
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            location.reload();
        }

        
        function showSection(sectionId) {
           
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
           
            document.getElementById(`section-${sectionId}`).style.display = 'block';
            
           
            if(sectionId === 'students') fetchStudents();
            if(sectionId === 'teachers') fetchTeachers();
            if(sectionId === 'attendance') fetchAttendance();
        }

        
        async function fetchStudents() {
            const res = await fetch(`${API_URL}/students`);
            const data = await res.json();
            const tbody = document.querySelector('#table-students tbody');
            tbody.innerHTML = '';
            data.forEach(s => {
                tbody.innerHTML += `<tr><td>${s.id}</td><td>${s.firstName}</td><td>${s.lastName}</td><td>${s.email}</td></tr>`;
            });
        }

        async function addStudent() {
            const payload = {
                firstName: document.getElementById('stu-fname').value,
                lastName: document.getElementById('stu-lname').value,
                email: document.getElementById('stu-email').value
            };
            await fetch(`${API_URL}/student`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            fetchStudents(); 
        }

        
        async function fetchTeachers() {
            const res = await fetch(`${API_URL}/teachers`);
            const data = await res.json();
            const tbody = document.querySelector('#table-teachers tbody');
            tbody.innerHTML = '';
            data.forEach(t => {
                tbody.innerHTML += `<tr><td>${t.id}</td><td>${t.firstName}</td><td>${t.lastName}</td><td>${t.subject}</td></tr>`;
            });
        }

        async function addTeacher() {
            const payload = {
                firstName: document.getElementById('teach-fname').value,
                lastName: document.getElementById('teach-lname').value,
                subject: document.getElementById('teach-subject').value
            };
            await fetch(`${API_URL}/teacher`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            fetchTeachers();
        }

        
        async function markAttendance() {
            const payload = {
                student_id: document.getElementById('att-stu-id').value,
                date: document.getElementById('att-date').value,
                status: document.getElementById('att-status').value
            };

            
            const res = await fetch(`${API_URL}/mark-attendance`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // <--- CRITICAL
                },
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                alert("Attendance Marked!");
                fetchAttendance();
            } else {
                alert("Failed. Are you logged in?");
            }
        }

        async function fetchAttendance() {
            const res = await fetch(`${API_URL}/get-attendance`);
            const data = await res.json();
            const tbody = document.querySelector('#table-attendance tbody');
            tbody.innerHTML = '';
            data.forEach(a => {
                tbody.innerHTML += `<tr><td>${a.id}</td><td>${a.date}</td><td>${a.student_id}</td><td>${a.status}</td></tr>`;
            });
        }

    </script>
</body>
</html>
